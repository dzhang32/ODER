---
title: "title"
author: "David Zhang"
output: 
  html_document:
    code_folding: show
    theme: spacelab
    highlight: kate
    df_print: paged
    toc: true
    toc_float: true
    number_sections: true
---

```{r setup, include = FALSE}

library(tidyverse)
library(stringr)
library(ggpubr)
devtools::load_all("~/packages/ODER/")

knitr::opts_chunk$set(echo = T, message = F, warning = F)

```

- For this example, we will use the GTEx v6 data made available through [recount2](https://jhubiostatistics.shinyapps.io/recount/)

# Download data

- We require a bigWig file and total AUC for each sample. Both of which can be obtained through the `recount` R package.
- For speed this workflow only demonstrates this run on 2 cerebellar samples. Though it would be advisable to use the bigwigs from as many samples as you have to gain a more accurate estimate of mean coverage. 

```{r}

gtex_metadata <- recount::all_metadata('gtex') 

gtex_metadata <- gtex_metadata %>% 
  as.data.frame() %>% 
  filter(smtsd == "Brain - Cerebellar Hemisphere", 
         smafrze == "USE ME") %>% 
  .[1:2, ]

# for(i in seq_along(gtex_metadata$bigwig_file)){
#   
#   download.file(url = str_c("http://duffel.rail.bio/recount/SRP012682/bw/", gtex_metadata$bigwig_file[i]), 
#                 destfile = str_c("~/data/", gtex_metadata$bigwig_file[i]), 
#                 method = "wget")
#   
# }

```

# Calculate mean coverage across your samples

- In order to apply a mean coverage cut off to define ERs, we must first collapse the information from bws across samples into a mean coverage. 
- To account for differences in library size, we normalise all bws to a target AUC. 

```{r}

bw_paths <- str_c("~/data/", gtex_metadata$bigwig_file)
bw_paths

aucs <- gtex_metadata$auc
aucs

chrs_mean_cov <- 
  cal_mean_cov(bw_paths, 
               aucs, 
               target_auc = (40e6 * 100), # target 40 million coverage with 100 bp length reads
               chr_to_filter = c("chr21", "chr22")) # defaults to chr1-22, chrX, chrY, chrM

chrs_mean_cov

```

# Generate ERs across different MCCs and MRGs

- 

```{r}

ERs_MCC_MRGs <- def_ERs(chr_mean_cov = chrs_mean_cov, 
                        MCCs = c(5, 10), 
                        MRGs = c(10, 20))

ERs_MCC_MRGs$MCC_5$MRG_10

```



